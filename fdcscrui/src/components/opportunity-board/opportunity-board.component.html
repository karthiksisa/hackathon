<div class="space-y-6">
  <div class="flex justify-between items-center">
    <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Sales Pipeline</h2>
    <button (click)="addOpportunity.emit()"
      class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
          clip-rule="evenodd" />
      </svg>
      Create Opportunity
    </button>
  </div>

  <div class="flex-1 overflow-x-auto">
    <div class="flex space-x-4 pb-4" cdkDropListGroup>
      @for(stage of stages; track stage) {
      <div class="w-72 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-sm flex-shrink-0 flex flex-col">
        <div
          [class]="'px-3 py-2 font-semibold text-gray-700 dark:text-gray-200 rounded-t-lg border-t-4 ' + getStageClass(stage).border">
          {{ stage }} ({{ opportunitiesByStage()[stage]?.length || 0 }})
        </div>
        <div cdkDropList [id]="stage" [cdkDropListData]="opportunitiesByStage()[stage]"
          (cdkDropListDropped)="drop($event)" (cdkDropListEntered)="entered($event)"
          [class]="'p-3 space-y-3 overflow-y-auto h-[calc(100vh-20rem)] flex-1 ' + getStageClass(stage).bg">
          @for(opp of opportunitiesByStage()[stage]; track opp.id) {
          <div cdkDrag [cdkDragData]="opp" (click)="viewOpportunity.emit(opp)"
            class="bg-white dark:bg-gray-700 p-3 rounded-md shadow hover:shadow-lg cursor-pointer transition-shadow">
            <p class="font-semibold text-sm text-gray-800 dark:text-gray-100">{{ opp.name }}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">{{ opp.accountName }}</p>
            <p class="text-[10px] text-gray-400 dark:text-gray-500">{{ opp.regionName || 'No Region' }}</p>
            <div class="flex justify-between items-center mt-2">
              <p class="text-sm font-bold text-gray-900 dark:text-gray-200">{{ opp.amount |
                currency:'INR':'symbol-narrow':'1.0-0' }}</p>
              <span class="text-xs text-gray-600 dark:text-gray-300">{{ opp.ownerName || getOwnerName(opp.ownerId)
                }}</span>
            </div>
          </div>
          } @empty {
          <!-- Empty placeholder to allow dropping into empty columns -->
          <div
            class="h-full min-h-[50px] flex items-center justify-center text-sm text-gray-500 dark:text-gray-400 border-2 border-dashed border-gray-300 rounded-md">
            Drop Here
          </div>
          }
        </div>
      </div>
      }
    </div>
  </div>
</div>